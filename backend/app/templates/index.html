<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Scalping Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
    <header>
        <h1>Options Scalping Portal</h1>
        <div id="controls">
            <button id="strategy-toggle">Start Strategy</button>
            <button id="kill-switch">EMERGENCY STOP</button>
        </div>
    </header>

    <main>
        <section id="overview">
            <div>
                <h2>Account Overview</h2>
                <div id="account-details">
                    <p>Balance: <span id="balance">--</span></p>
                    <p>Margin: <span id="margin">--</span></p>
                </div>
            </div>
            <div>
                <h2>Daily Stats</h2>
                <div id="daily-stats" class="stats-grid">
                    <p>Realized P&L: <span id="realized-pnl">--</span></p>
                    <p>Total Trades: <span id="total-trades">--</span></p>
                    <p>Win Rate: <span id="win-rate">--</span></p>
                    <p>Avg. Win: <span id="avg-win">--</span></p>
                    <p>Avg. Loss: <span id="avg-loss">--</span></p>
                    <p>Trading Status: <span id="trading-status" class="negative">STOPPED</span></p>
                    <p>Data Feed: <span id="data-feed-status">--</span></p>
                </div>
            </div>
        </section>

        <section id="strategy-params">
            <h2>Strategy Parameters</h2>
            <form id="params-form">
                <div class="form-grid">
                    <div>
                        <label for="param-ema-short">EMA Short</label>
                        <input type="number" id="param-ema-short" name="ema_short">
                    </div>
                    <div>
                        <label for="param-ema-long">EMA Long</label>
                        <input type="number" id="param-ema-long" name="ema_long">
                    </div>
                    <div>
                        <label for="param-atr-period">ATR Period</label>
                        <input type="number" id="param-atr-period" name="atr_period">
                    </div>
                    <div>
                        <label for="param-st-period">SuperTrend Period</label>
                        <input type="number" id="param-st-period" name="supertrend_period">
                    </div>
                    <div>
                        <label for="param-st-multiplier">SuperTrend Multiplier</label>
                        <input type="number" step="0.1" id="param-st-multiplier" name="supertrend_multiplier">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">Save Parameters</button>
                    <span id="params-status"></span>
                </div>
            </form>
        </section>

        <section id="chart-section">
            <h2>Market Chart</h2>
            <div id="trading-chart"></div>
        </section>

        <section id="pnl-chart-section">
            <h2>Daily P&L Chart</h2>
            <div id="pnl-chart"></div>
        </section>

        <section id="positions-and-orders">
            <div id="positions">
                <h2>Open Positions</h2>
                <table>
                    <thead>
                        <tr><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry Price</th><th>Live Price</th><th>P&L</th></tr>
                    </thead>
                    <tbody id="positions-table-body">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
            <div id="trades">
                <h2>Historical Trades</h2>
                <table>
                    <thead>
                        <tr><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry</th><th>Exit</th><th>P&L</th><th>Time</th></tr>
                    </thead>
                    <tbody id="trades-table-body">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <div id="backtest-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Options Backtesting</h2>
            <form id="backtest-form">
                <div class="form-grid">
                    <div><label for="backtest-start-date">Start Date</label><input type="date" id="backtest-start-date" required></div>
                    <div><label for="backtest-end-date">End Date</label><input type="date" id="backtest-end-date" required></div>
                    <div><label for="backtest-capital">Initial Capital</label><input type="number" id="backtest-capital" value="100000" min="10000" required></div>
                    <div><label for="backtest-index">Index</label><select id="backtest-index" required><option value="BANKNIFTY">BANKNIFTY</option><option value="NIFTY">NIFTY</option><option value="FINNIFTY">FINNIFTY</option></select></div>
                </div>
                <div class="form-actions">
                    <button type="submit" id="run-backtest-btn">Run Backtest</button>
                    <span id="backtest-status"></span>
                </div>
            </form>
            <div id="backtest-results" style="display: none;">
                <h3>Backtest Results</h3>
                <div class="results-grid">
                    <div class="result-item"><label>Total Return:</label><span id="bt-total-return" class="result-value">--</span></div>
                    <div class="result-item"><label>Win Rate:</label><span id="bt-win-rate" class="result-value">--</span></div>
                    <div class="result-item"><label>Total Trades:</label><span id="bt-total-trades" class="result-value">--</span></div>
                    <div class="result-item"><label>Max Drawdown:</label><span id="bt-max-drawdown" class="result-value">--</span></div>
                    <div class="result-item"><label>Sharpe Ratio:</label><span id="bt-sharpe-ratio" class="result-value">--</span></div>
                    <div class="result-item"><label>Avg Trade Duration:</label><span id="bt-avg-duration" class="result-value">--</span></div>
                </div>
                <div id="backtest-chart"></div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- STATE ---
            let isStrategyRunning = false;
            let pnlHistory = [];

            // --- ELEMENT REFERENCES ---
            const elements = {
                // Main Dashboard
                balance: document.getElementById('balance'),
                margin: document.getElementById('margin'),
                realizedPnl: document.getElementById('realized-pnl'),
                totalTrades: document.getElementById('total-trades'),
                winRate: document.getElementById('win-rate'),
                avgWin: document.getElementById('avg-win'),
                avgLoss: document.getElementById('avg-loss'),
                tradingStatus: document.getElementById('trading-status'),
                dataFeedStatus: document.getElementById('data-feed-status'),
                tradesTableBody: document.getElementById('trades-table-body'),
                positionsTableBody: document.getElementById('positions-table-body'),
                strategyToggleBtn: document.getElementById('strategy-toggle'),
                killSwitchBtn: document.getElementById('kill-switch'),
                paramsForm: document.getElementById('params-form'),
                paramsStatus: document.getElementById('params-status'),
                // Backtest Modal
                backtestModal: document.getElementById('backtest-modal'),
                backtestForm: document.getElementById('backtest-form'),
                backtestResults: document.getElementById('backtest-results'),
                backtestStatus: document.getElementById('backtest-status'),
                runBacktestBtn: document.getElementById('run-backtest-btn'),
                modalCloseBtn: document.querySelector('.close'),
                headerControls: document.getElementById('controls')
            };

            // --- CHART SETUP ---
            const mainChart = LightweightCharts.createChart(document.getElementById('trading-chart'), { width: 0, height: 400, layout: { backgroundColor: '#ffffff', textColor: '#333' }, grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } }, timeScale: { timeVisible: true, secondsVisible: true } });
            const mainCandleSeries = mainChart.addCandlestickSeries();

            const pnlChart = LightweightCharts.createChart(document.getElementById('pnl-chart'), { width: 0, height: 250, layout: { backgroundColor: '#ffffff', textColor: '#333' }, grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } }, timeScale: { timeVisible: true, secondsVisible: false } });
            const pnlSeries = pnlChart.addAreaSeries({ topColor: 'rgba(46, 204, 113, 0.56)', bottomColor: 'rgba(46, 204, 113, 0.04)', lineColor: 'rgba(46, 204, 113, 1)', lineWidth: 2 });
            
            let backtestChart; // Deferred initialization

            // --- UTILITY FUNCTIONS ---
            async function fetchJson(url, options = {}) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                        throw new Error(errorData.detail || `HTTP error ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    console.error(`Fetch error from ${url}:`, error);
                    throw error;
                }
            }

            function setStatus(element, message, type, duration = 3000) {
                element.textContent = message;
                element.className = type;
                if (duration) {
                    setTimeout(() => { element.textContent = ''; element.className = ''; }, duration);
                }
            }

            // --- UI UPDATE FUNCTIONS ---
            const updateUI = {
                account: (data) => {
                    elements.balance.textContent = `₹${Number(data.balance || 0).toFixed(2)}`;
                    elements.margin.textContent = `₹${Number(data.margin || 0).toFixed(2)}`;
                },
                stats: (data) => {
                    const pnl = Number(data.pnl || 0);
                    elements.realizedPnl.textContent = `₹${pnl.toFixed(2)}`;
                    elements.realizedPnl.className = pnl >= 0 ? 'positive' : 'negative';
                    elements.totalTrades.textContent = data.total_trades || 0;
                    elements.winRate.textContent = `${Number(data.win_rate || 0).toFixed(2)}%`;
                    elements.avgWin.textContent = `₹${Number(data.avg_win_pnl || 0).toFixed(2)}`;
                    elements.avgLoss.textContent = `₹${Number(data.avg_loss_pnl || 0).toFixed(2)}`;

                    isStrategyRunning = !data.is_trading_stopped;
                    elements.tradingStatus.textContent = isStrategyRunning ? 'RUNNING' : 'STOPPED';
                    elements.tradingStatus.className = isStrategyRunning ? 'positive' : 'negative';
                    updateUI.strategyButton();

                    const now = Math.floor(Date.now() / 1000);
                    pnlHistory.push({ time: now, value: data.equity });
                    pnlSeries.setData(pnlHistory);
                },
                positions: (data) => {
                    elements.positionsTableBody.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(pos => {
                            const row = elements.positionsTableBody.insertRow();
                            const pnlClass = pos.pnl >= 0 ? 'positive' : 'negative';
                            row.innerHTML = `<td>${pos.symbol}</td><td class="${pos.side.toLowerCase()}">${pos.side}</td><td>${pos.qty}</td><td>${Number(pos.entry_price).toFixed(2)}</td><td>${Number(pos.live_price).toFixed(2)}</td><td class="${pnlClass}">${pos.pnl.toFixed(2)}</td>`;
                        });
                    } else {
                        elements.positionsTableBody.innerHTML = '<tr><td colspan="6">No open positions.</td></tr>';
                    }
                },
                trades: (data) => {
                    elements.tradesTableBody.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(trade => {
                            const row = elements.tradesTableBody.insertRow(0); // Insert at the top
                            const pnlClass = trade.pnl >= 0 ? 'positive' : 'negative';
                            row.innerHTML = `<td>${trade.symbol}</td><td class="${trade.side.toLowerCase()}">${trade.side}</td><td>${trade.qty}</td><td>₹${Number(trade.entry_price).toFixed(2)}</td><td>₹${Number(trade.exit_price).toFixed(2)}</td><td class="${pnlClass}">₹${trade.pnl.toFixed(2)}</td><td>${new Date(trade.exit_time).toLocaleTimeString()}</td>`;
                        });
                    } else {
                        elements.tradesTableBody.innerHTML = '<tr><td colspan="7">No trades yet.</td></tr>';
                    }
                },
                params: (data) => {
                    elements.paramsForm.elements['ema_short'].value = data.ema_short;
                    elements.paramsForm.elements['ema_long'].value = data.ema_long;
                    elements.paramsForm.elements['atr_period'].value = data.atr_period;
                    elements.paramsForm.elements['supertrend_period'].value = data.supertrend_period;
                    elements.paramsForm.elements['supertrend_multiplier'].value = data.supertrend_multiplier;
                },
                strategyButton: () => {
                    elements.strategyToggleBtn.textContent = isStrategyRunning ? 'Stop Strategy' : 'Start Strategy';
                    elements.strategyToggleBtn.style.backgroundColor = isStrategyRunning ? '#f39c12' : '#2ecc71';
                    elements.strategyToggleBtn.disabled = false;
                },
                backtestResults: (data) => {
                    document.getElementById('bt-total-return').textContent = `${Number(data.total_return).toFixed(2)}%`;
                    document.getElementById('bt-win-rate').textContent = `${Number(data.win_rate).toFixed(1)}%`;
                    document.getElementById('bt-total-trades').textContent = data.total_trades;
                    document.getElementById('bt-max-drawdown').textContent = `${Number(data.max_drawdown).toFixed(2)}%`;
                    document.getElementById('bt-sharpe-ratio').textContent = Number(data.sharpe_ratio).toFixed(2);
                    document.getElementById('bt-avg-duration').textContent = `${Number(data.avg_duration).toFixed(1)} min`;

                    const backtestChartContainer = document.getElementById('backtest-chart');
                    backtestChartContainer.innerHTML = '';
                    backtestChart = LightweightCharts.createChart(backtestChartContainer, { width: backtestChartContainer.clientWidth, height: 300, ...mainChart.options() });
                    const backtestEquitySeries = backtestChart.addAreaSeries({ topColor: 'rgba(46, 204, 113, 0.56)', bottomColor: 'rgba(46, 204, 113, 0.04)', lineColor: 'rgba(46, 204, 113, 1)', lineWidth: 2 });
                    backtestEquitySeries.setData(data.equity_curve);

                    elements.backtestResults.style.display = 'block';
                }
            };

            // --- DATA FETCHING & WEBSOCKETS ---
            async function fetchInitialData() {
                try {
                    const [account, stats, trades, positions, params] = await Promise.all([
                        fetchJson('/api/account'), fetchJson('/api/stats'), fetchJson('/api/trades'),
                        fetchJson('/api/positions'), fetchJson('/api/strategy/parameters')
                    ]);
                    updateUI.account(account);
                    updateUI.stats(stats);
                    updateUI.trades(trades);
                    updateUI.positions(positions);
                    updateUI.params(params);
                } catch (error) {
                    console.error("Failed to fetch initial data:", error);
                }
            }

            function connectWebSocket() {
                const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/api/ws/data`);
                ws.onopen = () => { setStatus(elements.dataFeedStatus, 'CONNECTED', 'positive', 0); };
                ws.onclose = () => { setStatus(elements.dataFeedStatus, 'DISCONNECTED', 'negative', 0); setTimeout(connectWebSocket, 5000); };
                ws.onerror = () => { setStatus(elements.dataFeedStatus, 'ERROR', 'negative', 0); };
                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        switch (msg.type) {
                            case 'ping': ws.send(JSON.stringify({ type: 'pong' })); break;
                            case 'stats_update': updateUI.stats(msg.data); break;
                            case 'order_update':
                                fetchJson('/api/positions').then(updateUI.positions);
                                fetchJson('/api/trades').then(updateUI.trades);
                                break;
                            case 'market_data':
                                setStatus(elements.dataFeedStatus, 'CONNECTED', 'positive', 0);
                                break; // Placeholder for chart updates
                        }
                    } catch (err) { console.error('WS message processing error:', err); }
                };
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                elements.strategyToggleBtn.addEventListener('click', async () => {
                    const action = isStrategyRunning ? 'stop' : 'start';
                    elements.strategyToggleBtn.disabled = true;
                    try {
                        await fetchJson('/api/strategy/control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action }) });
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                        updateUI.strategyButton();
                    }
                });

                elements.killSwitchBtn.addEventListener('click', async () => {
                    if (confirm('EMERGENCY STOP: This will halt all trading. Are you sure?')) {
                        try {
                            await fetchJson('/api/strategy/control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'kill' }) });
                            alert('Kill switch activated. Trading halted.');
                            elements.strategyToggleBtn.disabled = true;
                            elements.killSwitchBtn.disabled = true;
                        } catch (error) { alert(`Error: ${error.message}`); }
                    }
                });

                elements.paramsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(elements.paramsForm);
                    const params = {
                        instruments: ["NIFTYBEES-EQ"], timeframe: "1m",
                        ema_short: parseInt(formData.get('ema_short')), ema_long: parseInt(formData.get('ema_long')),
                        supertrend_period: parseInt(formData.get('supertrend_period')), supertrend_multiplier: parseFloat(formData.get('supertrend_multiplier')),
                        atr_period: parseInt(formData.get('atr_period')),
                    };
                    try {
                        await fetchJson('/api/strategy/parameters', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
                        setStatus(elements.paramsStatus, 'Saved successfully!', 'positive');
                    } catch (error) {
                        setStatus(elements.paramsStatus, `Error: ${error.message}`, 'negative');
                    }
                });

                // Backtest Modal Listeners
                const backtestBtn = document.createElement('button');
                backtestBtn.textContent = 'Backtest Strategy';
                backtestBtn.id = 'backtest-btn';
                elements.headerControls.appendChild(backtestBtn);

                backtestBtn.addEventListener('click', () => { elements.backtestModal.style.display = 'block'; });
                elements.modalCloseBtn.addEventListener('click', () => { elements.backtestModal.style.display = 'none'; });
                window.addEventListener('click', (e) => { if (e.target === elements.backtestModal) elements.backtestModal.style.display = 'none'; });

                elements.backtestForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    elements.runBacktestBtn.disabled = true;
                    elements.runBacktestBtn.textContent = 'Running...';
                    setStatus(elements.backtestStatus, 'Running backtest...', 'info', 0);
                    elements.backtestResults.style.display = 'none';
                    try {
                        const formData = new FormData(elements.backtestForm);
                        const results = await fetchJson('/api/backtest', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                start_date: formData.get('backtest-start-date'), end_date: formData.get('backtest-end-date'),
                                initial_capital: parseFloat(formData.get('backtest-capital')), index: formData.get('backtest-index')
                            })
                        });
                        updateUI.backtestResults(results.data);
                        setStatus(elements.backtestStatus, 'Backtest completed!', 'positive');
                    } catch (err) {
                        setStatus(elements.backtestStatus, `Backtest failed: ${err.message}`, 'negative');
                    } finally {
                        elements.runBacktestBtn.disabled = false;
                        elements.runBacktestBtn.textContent = 'Run Backtest';
                    }
                });
            }

            // --- INITIALIZATION ---
            function init() {
                // Set initial chart sizes
                mainChart.resize(elements.headerControls.clientWidth, 400);
                pnlChart.resize(elements.headerControls.clientWidth, 250);
                
                fetchInitialData();
                connectWebSocket();
                setupEventListeners();
            }

            init();
        });
    </script>

</body>
</html>
